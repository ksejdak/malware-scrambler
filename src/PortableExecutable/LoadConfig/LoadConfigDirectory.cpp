#include "LoadConfigDirectory.h"
#include "Utils\Debug\Debug.h"

#include <cstring>
#include <sstream>
#include <string>
#include <boost\scoped_array.hpp>

LoadConfigDirectory::LoadConfigDirectory(PIMAGE_DATA_DIRECTORY dataDirectoryEntry, PEFile* PE)
    : DataDirectoryEntry(dataDirectoryEntry, PE)
{
    LOG_EMPTY();
    LOG_INFO("Load config directory:");

    uint8_t* loadConfigPtr = getDataForRVA(m_entryRVA);
    m_loadConfig = reinterpret_cast<PIMAGE_LOAD_CONFIG_DIRECTORY>(loadConfigPtr);
    SHOW_HEX(m_loadConfig->LockPrefixTable);
    SHOW_HEX(m_loadConfig->EditList);
    SHOW_HEX(m_loadConfig->SecurityCookie);
    SHOW_HEX(m_loadConfig->SEHandlerTable);

    LOG_EMPTY();
}

void LoadConfigDirectory::addToRVAs(unsigned long value)
{
    if(m_loadConfig->LockPrefixTable)
        m_loadConfig->LockPrefixTable += value;

    if(m_loadConfig->EditList)
        m_loadConfig->EditList += value;

    if(m_loadConfig->SecurityCookie)
        m_loadConfig->SecurityCookie += value;

    if(m_loadConfig->SEHandlerTable)
        m_loadConfig->SEHandlerTable += value;
}