#include "ResourceDirectory.h"
#include "ResourceEntry.h"
#include "Utils\Debug\Debug.h"

#include <sstream>

ResourceDirectory::ResourceDirectory(PESection* section, PIMAGE_RESOURCE_DIRECTORY_ENTRY entry)
    : IResourceComponent(section, entry)
{
    m_isRoot = entry ? false : true;
}

bool ResourceDirectory::isDirectory()
{
    return true;
}

unsigned int ResourceDirectory::getNamedResourcesCount()
{
    unsigned int namedResourcesCount = 0;
    for(std::shared_ptr<IResourceComponent> child : m_entries)
    {
        if(child->isNamed())
            ++namedResourcesCount;
    }

    return namedResourcesCount;
}

unsigned int ResourceDirectory::getIdResourcesCount()
{
    unsigned int idResourcesCount = 0;
    for(std::shared_ptr<IResourceComponent> child : m_entries)
    {
        if(!child->isNamed())
            ++idResourcesCount;
    }

    return idResourcesCount;
}

void ResourceDirectory::add(std::shared_ptr<IResourceComponent> entry)
{
    m_entries.push_back(entry);
}

void ResourceDirectory::debugPrint(int indentation)
{
    std::stringstream ss;
    ss << std::string(indentation, '\t') << "<DIR> " << getComponentName();
    LOG_DEBUG(ss.str());

    int entriesIndentation = indentation + 1;
    for(std::shared_ptr<IResourceComponent> child : m_entries)
        child->debugPrint(entriesIndentation);
}

ResourceIterator::ResourceIterator(std::shared_ptr<ResourceDirectory> begin)
    : m_begin(begin)
    , m_currentParent(begin)
{
    m_currentChildNumStack.push_back(-1);
}

std::shared_ptr<ResourceEntry> ResourceIterator::getNext()
{
    m_currentChildNumStack.front() += 1;
    int currentChildNum = m_currentChildNumStack.front();

    while(currentChildNum == m_currentParent->m_entries.size())
    {
        if(m_currentParent == m_begin)
        {
            m_currentResource.reset();
            return m_currentResource;
        }

        m_currentParent = std::static_pointer_cast<ResourceDirectory>(m_currentParent->m_parentComponent);
        m_currentChildNumStack.pop_front();
        m_currentChildNumStack.front() += 1;
        currentChildNum = m_currentChildNumStack.front();
    }

    while(m_currentParent->m_entries[currentChildNum]->isDirectory())
    {
        m_currentChildNumStack.push_front(0);
        m_currentParent = std::static_pointer_cast<ResourceDirectory>(m_currentParent->m_entries[currentChildNum]);
        currentChildNum = m_currentChildNumStack.front();
    }
    
    m_currentResource = std::static_pointer_cast<ResourceEntry>(m_currentParent->m_entries[currentChildNum]);
    return m_currentResource;
}