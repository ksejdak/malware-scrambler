from Utils.Logger       import Logger
from API.RequestHandler import RequestHandler
from API.ResponseParser import ScanResponseParser, ScanReportParser

from time               import sleep
import os

class VirusTotalClient(object):
    
    def __init__(self):
        self.__log = Logger.getLogger()
        self.__resourceList = []

    def run(self, filesDirectory):
        self.__send(filesDirectory)
        self.__log.info("===============================================================================================================================\n")
        self.__getReports()

    def __send(self, filesDirectory):
        requestHandler = RequestHandler()
        scanResponseParser = ScanResponseParser()

        # send all files in provided directory
        for filename in os.listdir(filesDirectory):
            filePath = filesDirectory + filename
            response = requestHandler.scanFile(filePath)

            scanResponseParser.parse(response)
            if(scanResponseParser.getResponseCode() == scanResponseParser.SUCCESS):
                resource = scanResponseParser.getResource()
                self.__resourceList.append(resource)
                scanResponseParser.save()
                scanResponseParser.clear()
                self.__log.info("Scanning file SUCCESS\n")
            else:
                self.__log.error("Scanning file FAILED: [%s]\n", scanResponseParser.getMessage())

    def __getReports(self):
        requestHandler = RequestHandler()
        scanReportParser = ScanReportParser()

        # get reports for each scanned file
        for resource in self.__resourceList:
            while True:
                report = requestHandler.getScanReport(resource)

                scanReportParser.parse(report)
                if(scanReportParser.getResponseCode() == scanReportParser.SUCCESS):
                    scanReportParser.save()
                    self.__log.info("Getting report SUCCESS\n")
                    break
                else:
                    self.__log.error("Getting report FAILED: [%s]\n", scanReportParser.getMessage())
                    sleep(20)