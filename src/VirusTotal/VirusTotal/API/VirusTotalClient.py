from Utils.Logger       import Logger
from API.RequestHandler import RequestHandler
from API.ResponseParser import ScanResponseParser, ScanReportParser

from time               import sleep
import os

class VirusTotalClient(object):
    
    def __init__(self):
        self.__log = Logger.getLogger()
        self.__resourceDict = {}

    def run(self, filesDirectory):
        self.__send(filesDirectory)
        self.__log.info("===============================================================================================================================\n")
        self.__getReports()

    def __send(self, filesDirectory):
        requestHandler = RequestHandler()
        scanResponseParser = ScanResponseParser()

        # send all files in provided directory
        for filename in os.listdir(filesDirectory):
            filePath = filesDirectory + filename
            self.__log.info("Sending to SCAN in VirusTotal: [%s]", filePath)
            response = requestHandler.scanFile(filePath)

            scanResponseParser.parse(response)
            if(scanResponseParser.getResponseCode() == scanResponseParser.SUCCESS):
                resource = scanResponseParser.getResource()
                self.__resourceDict[filePath] = resource
                scanResponseParser.save(filePath)
                scanResponseParser.clear()
                self.__log.info("Scanning file SUCCESS\n")
            else:
                self.__log.error("Scanning file FAILED: [%s]\n", scanResponseParser.getMessage())

    def __getReports(self):
        requestHandler = RequestHandler()
        scanReportParser = ScanReportParser()

        # get reports for each scanned file
        requestCounter = 0
        for filePath, resource in self.__resourceDict.iteritems():
            self.__log.info("Getting REPORT from VirusTotal: [%s]", filePath)

            while True:
                if(requestCounter == 4):
                    self.__log.info("Waiting 70 sec due to VirusTotal limitation\n")
                    sleep(70)
                    requestCounter = 0

                requestCounter += 1
                report = requestHandler.getScanReport(resource)
                scanReportParser.parse(report)
                if(scanReportParser.getResponseCode() == scanReportParser.SUCCESS):
                    scanReportParser.save(filePath)
                    self.__log.info("Getting report SUCCESS\n")
                    break
                else:
                    if(scanReportParser.getResponseCode() == scanReportParser.FAILED):
                        self.__log.error("Getting report FAILED: [%s]\n", scanReportParser.getMessage())
                    # wait to give some time to VirusTotal to process
                    sleep(20)