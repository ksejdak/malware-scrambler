#include "MalwareScrambler.h"
#include "PortableExecutable\PortableExecutableCommon\PEFile.h"
#include "MutationEngine\MutationPipeline.h"
#include "MutationEngine\MutationPipelineFactory.h"
#include "Utils\Debug\Debug.h"
#include "Utils\Toolbox\Version.h"

#include <sstream>
#include <boost\filesystem.hpp>

MalwareScrambler::MalwareScrambler(const std::string& inputPath, const std::string& outputPath, const std::string& configPath)
    : m_inputPath(inputPath.c_str())
    , m_outputPath(outputPath.c_str())
    , m_configPath(configPath.c_str())
    , m_multipleFileProcessing(boost::filesystem::is_directory(m_inputPath))
{
}

void MalwareScrambler::run()
{
    LOG_INFO("Starting code-scrambler");

    std::shared_ptr<MutationPipeline> mutationPipeline = MutationPipelineFactory::getInstance().createPipeline(m_configPath);
    if(m_multipleFileProcessing)
    {
        boost::filesystem::directory_iterator dirItEnd;
        for(boost::filesystem::directory_iterator dirIt(m_inputPath); dirIt != dirItEnd; ++dirIt)
        {
            if(!boost::filesystem::is_regular_file(dirIt->status()))
                continue;

            processOneFile(mutationPipeline, dirIt->path().string());
        }
    }
    else
        processOneFile(mutationPipeline, m_inputPath);
}

std::string MalwareScrambler::getVersion()
{
    return PROGRAM_VERSION;
}

std::string MalwareScrambler::getAuthor()
{
    return PROGRAM_AUTHOR;
}

std::string MalwareScrambler::getBuildDate()
{
    return BUILD_TIME + " " + BUILD_DATE;
}

void MalwareScrambler::processOneFile(std::shared_ptr<MutationPipeline> mutationPipeline, const std::string& filePath)
{
    LOG_INFO("=========================================================================");
    LOG_INFO("Processing [file: " + filePath + "]");

    boost::filesystem::path currentPath = filePath;
    boost::filesystem::path outputPath = m_outputPath;
    outputPath /= "scrambled_" + currentPath.filename().string();

    try
    {
        std::shared_ptr<PEFile> PEFile(new PEFile(currentPath));
        mutationPipeline->process(PEFile);
        PEFile->save(outputPath);
    }
    catch(std::exception& exc)
    {
        if(!m_multipleFileProcessing)
        {
            std::exception_ptr excPtr = std::current_exception();
            std::rethrow_exception(excPtr);
        }

        std::stringstream ss;
        ss << "exception occured: [what: " << exc.what() << "], but multiple file processing, skipping";
        LOG_ERROR(ss.str());
    }
}