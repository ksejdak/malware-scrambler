#include "MutationEngineManager.h"
#include "Utils\Debug\Debug.h"
#include "MutationEngine\Encryption\EncryptionEngine.h"
#include "MutationEngine\Encryption\CopyEncryptionMoverEngine.h"
#include "MutationEngine\Encryption\CopyEncryptionEngine.h"
#include "MutationEngine\Encryption\CopyEncryptionFinalizerEngine.h"
#include "MutationEngine\Layout\SectionResizer.h"
#include "MutationEngine\Layout\ResourceExtractor.h"
#include "MutationEngine\Layout\GarbageCodeInjector.h"
#include "MutationEngine\Imports\IATDeleterEngine.h"

#include <stdexcept>
#include <sstream>
#include <boost\assign.hpp>

enum EngineType
{
    UNKNOWN_ENGINE,
    ENCRYPTION_ENGINE,
    COPY_ENCRYPTION_MOVER_ENGINE,
    COPY_ENCRYPTION_ENGINE,
    COPY_ENCRYPTION_FINALIZER_ENGINE,
    SECTION_RESIZER,
    RESOURCE_EXTRACTOR,
    GARBAGE_CODE_INJECTOR,
    IAT_DELETER_ENGINE
};

static EngineType engineNameToType(std::string engineName)
{
    std::map<std::string, EngineType> engineTypes = boost::assign::map_list_of("EncryptionEngine",              ENCRYPTION_ENGINE)
                                                                              ("CopyEncryptionMoverEngine",     COPY_ENCRYPTION_MOVER_ENGINE)
                                                                              ("CopyEncryptionEngine",          COPY_ENCRYPTION_ENGINE)
                                                                              ("CopyEncryptionFinalizerEngine", COPY_ENCRYPTION_FINALIZER_ENGINE)
                                                                              ("SectionResizer",                SECTION_RESIZER)
                                                                              ("ResourceExtractor",             RESOURCE_EXTRACTOR)
                                                                              ("GarbageCodeInjector",           GARBAGE_CODE_INJECTOR)
                                                                              ("IATDeleterEngine",              IAT_DELETER_ENGINE)
                                                                              ;

    if(engineTypes.find(engineName) == engineTypes.end())
        return UNKNOWN_ENGINE;

    return engineTypes[engineName];
}

std::shared_ptr<IMutationEngine> MutationEngineManager::createMutationEngine(std::string name, const boost::property_tree::ptree& engineTree)
{
    std::shared_ptr<IMutationEngine> engine;
    EngineType engineType = engineNameToType(name);

    switch(engineType)
    {
    case ENCRYPTION_ENGINE:
        engine.reset(new EncryptionEngine(engineTree));
        break;
    case COPY_ENCRYPTION_MOVER_ENGINE:
        engine.reset(new CopyEncryptionMoverEngine(engineTree));
        break;
    case COPY_ENCRYPTION_ENGINE:
        engine.reset(new CopyEncryptionEngine(engineTree));
        break;
    case COPY_ENCRYPTION_FINALIZER_ENGINE:
        engine.reset(new CopyEncryptionFinalizerEngine(engineTree));
        break;
    case SECTION_RESIZER:
        engine.reset(new SectionResizer(engineTree));
        break;
    case RESOURCE_EXTRACTOR:
        engine.reset(new ResourceExtractor(engineTree));
        break;
    case GARBAGE_CODE_INJECTOR:
        engine.reset(new GarbageCodeInjector(engineTree));
        break;
    case IAT_DELETER_ENGINE:
        engine.reset(new IATDeleterEngine(engineTree));
        break;
    case UNKNOWN_ENGINE:
        // pass through
    default:
        std::stringstream errMsg;
        errMsg << MODULE_NAME + " engine \"" << name << "\" does not exist";
        throw std::runtime_error(errMsg.str());
    }

    return engine;
}