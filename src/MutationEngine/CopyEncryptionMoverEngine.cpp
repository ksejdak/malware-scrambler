#include "CopyEncryptionMoverEngine.h"
#include "Utils\Debug\Debug.h"
#include "Utils\CodeProvider\ICodeProvider.h"

CopyEncryptionMoverEngine::CopyEncryptionMoverEngine(const boost::property_tree::ptree& engineTree)
    : IMutationEngine("CopyEncryptionMoverEngine")
{
}

void CopyEncryptionMoverEngine::mutate(std::shared_ptr<PEFile> PE, std::map<std::string, std::string>& context)
{
    LOG_EMPTY();
    LOG_INFO("Starting mutation...");

    unsigned long entryPointRVA = PE->getNTHeaders()->OptionalHeader.AddressOfEntryPoint;
    unsigned long baseOfCode = PE->getNTHeaders()->OptionalHeader.BaseOfCode;
    unsigned long entryPointOffset = entryPointRVA - baseOfCode;

    size_t decodersSize = 0;

    std::vector<const boost::property_tree::ptree>& registeredCodeProviders = ICodeProvider::getRegisteredCodeProviders();
    for(const boost::property_tree::ptree providerTree : registeredCodeProviders)
    {
        std::shared_ptr<ICodeProvider> codeProvider = ICodeProvider::create(providerTree, false);
        decodersSize += codeProvider->getUserCode(true).size();
    }

    // get code section
    std::shared_ptr<PESection> codeSection = PE->RVAToSection(baseOfCode);
    std::shared_ptr<std::vector<uint8_t>> code = codeSection->getData();

    // get last section
    std::string lastSectionName = PE->getSectionsOrder().back();
    std::shared_ptr<PESection> lastSection = PE->getSections()[lastSectionName];
    std::shared_ptr<std::vector<uint8_t>> lastSectionData = lastSection->getData();

    // move code from code section to last section
    lastSectionData->insert(lastSectionData->end(), code->begin() + entryPointOffset, code->begin() + entryPointOffset + decodersSize);
    unsigned long exiledCodeRVA = lastSection->getSectionHeader()->VirtualAddress + lastSection->getVirtualSize();

    // update context for other copy encryption modules
    context["exiledCodeSize"] = std::to_string(decodersSize);
    context["exiledCodeRVA"] = std::to_string(exiledCodeRVA);

    registeredCodeProviders.clear();

    LOG_INFO("Mutation success!");
}