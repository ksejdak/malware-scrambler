#include "IMutationEngine.h"
#include "Utils\Debug\Debug.h"

#include <algorithm>
#include <sstream>

bool IMutationEngine::findInRequiredSubnodes(const std::string& nodeName)
{
    std::vector<std::string>& requiredSubnodes = getRequiredSubnodes();
    if(std::find(requiredSubnodes.begin(), requiredSubnodes.end(), nodeName) != requiredSubnodes.end())
        return true;

    return false;
}

void IMutationEngine::validateSubtree(const boost::property_tree::ptree& engineTree)
{
    std::vector<std::string> foundSubnodes;
    for(const boost::property_tree::ptree::value_type& node : engineTree)
    {
        std::string nodeName = node.first.data();
        if(nodeName == getName())
            continue;

        if(!findInRequiredSubnodes(nodeName))
        {
            std::stringstream errMsg;
            errMsg << MODULE_NAME + " engine [" << getName() << "] does not require subnode [" << nodeName << "]";
            throw std::runtime_error(errMsg.str());
        }

        foundSubnodes.push_back(nodeName);
    }

    std::vector<std::string>& requiredSubnodes = getRequiredSubnodes();
    std::sort(requiredSubnodes.begin(), requiredSubnodes.end());
    std::sort(foundSubnodes.begin(), foundSubnodes.end());

    auto diff = std::mismatch(foundSubnodes.begin(), foundSubnodes.end(), requiredSubnodes.begin());
    if(foundSubnodes.size() != requiredSubnodes.size() || diff.first != foundSubnodes.end())
    {
        std::stringstream errMsg;
        errMsg << MODULE_NAME + " engine [" << getName() << "] has invalid XML subtree";
        throw std::runtime_error(errMsg.str());
    }
}