#include "EncryptionEngine.h"
#include "Utils\Assembler\TemplateAssembler.h"
#include "Utils\Debug\Debug.h"

EncryptionEngine::EncryptionEngine(const boost::property_tree::ptree& engineTree)
    : IMutationEngine("EncryptionEngine")
{
    bool codeTemplateFound = false;
    for(const boost::property_tree::ptree::value_type& node : engineTree)
    {
        if(std::string(node.first.data()) != "CodeTemplate")
            continue;

        std::string codeTemplatePath = node.second.get<std::string>("<xmlattr>.path", "");
        m_assembler = node.second.get<std::string>("<xmlattr>.assembler", "");
        m_params = node.second.get<std::string>("<xmlattr>.params", "");

        if(codeTemplatePath == "" || m_assembler == "")
            throw std::runtime_error(MODULE_NAME + " one or more attributes is empty in CodeTemplate node");

        m_codeTemplatePath = codeTemplatePath;
        if(!boost::filesystem::exists(m_codeTemplatePath))
        {
            std::stringstream errMsg;
            errMsg << MODULE_NAME + " file \"" << codeTemplatePath << "\" does not exist";
            throw std::runtime_error(errMsg.str());
        }

        codeTemplateFound = true;
        break;
    }

    if(!codeTemplateFound)
        throw std::runtime_error(MODULE_NAME + " no CodeTemplate node found in Engine node");
}

void EncryptionEngine::mutate(std::shared_ptr<PEFile> PE, std::map<std::string, std::string>& context)
{
    std::unique_ptr<TemplateAssembler> assembler(new TemplateAssembler(m_codeTemplatePath, m_assembler, m_params));
    assembler->assemble();
    std::vector<uint8_t> decryptorCode = assembler->getUserCode();
}